{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}

    <div class="container-fluid py-4">

      <div class="raw mt-3">
        <H1>Welcome {{ request.user.username }} </H1>
      </div> 
      <div class="row mt-5">
        <div class="col-xl-3 col-sm-6 mb-l-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Price</p>
                    <h5 class="font-weight-bolder mb-0">
                      {{ summary_data.latest_opps|floatformat:"2" }}
                        {% if summary_data.opps_difference == 0 %}
                        <span class="text-secondary text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                        {% elif summary_data.opps_difference > 0 %}
                        <span class="text-success text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                        {% else %}
                        <span class="text-danger text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                      {% endif %}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Availability</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-success text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Assortment</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-danger text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">PPD</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-success text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      
  <div class="row mt-4">
    <div class="col-lg-7 mb-lg-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-lg-6">
              <div class="d-flex flex-column h-100">
                <h5 class="font-weight-bolder">EcomMan Score</h5>
                <p class="mb-5">EcomMan Score is your AI-powered ally for product performance. With a single, easy-to-understand score, you can monitor real-time performance, predict future trends, optimize pricing strategies, and enhance product visibility. Don't just guess, optimize. Empower your business with EcomMan Score today.
 
                </p>
                <a class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
                  Read More
                  <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
                </a>
              </div>
            </div>
            <div class="col-lg-5 ms-auto text-center mt-5 mt-lg-0">
              <div class="bg-gradient border-radius-lg h-100">
                <div class="position-relative d-flex align-items-center justify-content-center h-100 border border-4 border-danger">
                  <div class=" card numbers">
                    <h1>{{ summary_data.latest_opps|floatformat:"2" }}</h1>  

                    {% if summary_data.opps_difference == 0 %}
                    <span class="text-secondary text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                    {% elif summary_data.opps_difference > 0 %}
                    <span class="text-success text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                    {% else %}
                    <span class="text-danger text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                  {% endif %}

                      <!-- <h1>69.24 </h1>  
                      <span class="text-danger text-sm font-weight-bolder">-13.56</span> -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card h-100 p-3">
        <div class="overflow-hidden position-relative border-radius-lg bg-cover h-100" style="background-image: url('{% static 'img/ivancik.jpg' %}')">
          <span class="mask bg-gradient-dark"></span>
          <div class="card-body position-relative z-index-1 d-flex flex-column h-100 p-3">
            <h5 class="text-white font-weight-bolder mb-4 pt-2">EcomMan Report</h5>
            <p class="text-white">Check out your tailered report gerenrated by AI with full SWOT analysis for each one of your products. with the power
               of machine learning, now you can make sure that your products will rull
              
            </p>
            <a class="text-white text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
              Read More
              <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

<br>

      <div class="row my-4">
        <head>
          <meta charset="UTF-8">
          <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
          <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
      
          <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
          <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
          <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
          <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
      </head>


      <div class="raw mt-3">
        <h2>My Favourite Views</h2>
      </div> 
      <p>

        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
          My Favourite Views
        </button>
      </p>
      <div class="collapse" id="collapseExample">
        {% for pinned_table in pinned_tables %}


          {% if pinned_table.table_name == 'CurrentPriceStatus' %}

          <div class="row">

            <script>
              // Auto-dismiss alert after 5 seconds (5000 ms)
              document.addEventListener("DOMContentLoaded", function () {
                const alertElement = document.querySelector(".alert-dismissible");
                if (alertElement) {
                  setTimeout(() => {
                    alertElement.classList.remove("show"); // Remove 'show' class
                    alertElement.classList.add("fade");   // Optionally add 'fade' class for transition
                    alertElement.style.display = "none";  // Hide the alert
                  }, 5000); // 5000 ms = 5 seconds
                }
              });
            </script>
            
           
            <div class="container-fluid py-4">
            
              {% if messages %}
              <div class="container mt-4">
                {% for message in messages %}
                  <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            
            
            <div class="row mt-4">
              <h1>Current Price Status </h1>
            </div>
            
            
            <div class="col-12">
              <div class="card">
                <div class="card-header pb-0">
                  <div class="row">
                    <div class="col-lg-6 col-7">
                      <p class="text-sm mb-0">
                        The table's last update was on <span style="font-weight: bold;" >{{ latest_scraped_date|date:"F j, Y, g:i a" }}</span>
                    </div>
                  </div>
                </div>
            
                <div class="card-body px-0 pb-2">
            
                  <div class="container-fluid">
                    <div class="raw">
            
                      <form action="{% url 'dashboard:trigger_scrape_for_user_products' %}" method="post">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                          <button class="btn btn-primary" type="submit">Update Price Now</button>
                        </div>
                      </form>
                    
                    </div>
                  </div>
                  
                  <div class="container-fluid">
                    <div class="raw">
                  <!-- Product and Column Selection Form -->
                  <div class="d-grid gap-2">
            
                  <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                    Filter Prodcuts and columns 
                  </button>
                  </div>
            
                  <div class="collapse" id="collapseExample">
                  
                  <form method="get" id="filter-form" class="mb-4">
                    <div class="row g-3">
                        <!-- Product Dropdown -->
                        <div class="col-md-6">
                            <label for="products" class="form-label fw-bold">Select Products:</label>
                            <select id="products" name="products" class="form-select" multiple>
                                {% for product in all_products %}
                                    <option value="{{ product.id }}" {% if product.id|stringformat:"s" in selected_product_ids %}selected{% endif %}>
                                        {{ product.TITLE }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple products.</small>
                        </div>
                  
                        <!-- Columns Checkbox Dropdown -->
                        <div class="col-md-6">
                          <label for="columns">Select Columns to Display:</label><br>
                          {% for column in columns %}
                              <input type="checkbox" name="columns" value="{{ column.name }}" id="{{ column.name }}"
                                    {% if column.name in selected_columns %}checked{% endif %}>
                              <label for="{{ column.name }}">{{ column.header }}</label><br>
                          {% endfor %}
                        </div>
            
            
                        
                    </div>
                  
                    <!-- Submit Button -->
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                    </div>
                  </form>
                  
                  </div>
                    
                    </div>
                  </div>
                  
                  <div class="card-body px-0 pb-2">
                      <div class="table-responsive">
                          <!-- Product Table -->
                          <table class="table align-items-center mb-0" id="CurrentPriceStatus" class="display">
                            <thead>
                                <tr>
                                    <th class="text-center">Product</th>
                                    {% for column in columns %}
                                        <th class="text-center">{{ column.header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in max_scraped_data %}
                                    <tr>
                                        <td>{{ data.product.TITLE }}</td>
                                        {% for column in columns %}
                                            <td class="text-center">
                                                {% if "_price" in column.name or "_discount" in column.name %}
                                                    {{ data|get_item2:column.name|default_if_none:"N/A" }}
                                                {% elif "_compliance_flag" in column.name %}
                                                    {% if data|get_item2:column.name %}
                                                        <span class="badge bg-success">Compliant</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Non-Compliant</span>
                                                    {% endif %}
                          
                                                {% elif "promo_flag" in column.name %}
                                                  {% if data.promo_flag %}
                                                    <span class="badge badge-sm bg-gradient-success">{{data.discount_percentage}}%</span>        
                          
                                                    {% else %}
                                                    <span class="badge badge-sm bg-gradient-secondary">OFF</span>        
                                                    {% endif %}
                            
                                                {% elif "RSP" in column.name %}
                                                    {{ data.product.RSP|floatformat:"2" }}
                          
                                                {% elif "final_price" in column.name %}
                                                    {{ data.product.final_price|floatformat:"2" }}
                          
                                                {% elif "amazon_sold_by" in column.name %}
                                                  {{ data.amazon_sold_by }}
                          
                                                {% elif "noon_sa_sold_by" in column.name %}
                                                  {{ data.noon_sa_sold_by }}
                          
                                                {% elif "opps" in column.name %}
                                                  {{ data.opps|floatformat:"2" }}
                          
                                                {% elif "price_deviation_score" in column.name %}
                                                  {{ data.price_deviation_score|floatformat:"2" }}                        
                                                {% elif "account_deviation_score" in column.name %}
                                                  {{ data.account_deviation_score|floatformat:"2" }}                        
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                          </table>
                      </div>
                  </div>
                  
                  <div class="col p-4">
                    <a href="{% url 'dashboard:toggle_pin_table' 'CurrentPriceStatus' %}" >
                        {% if is_table_pinned %}
                            Unpin Table
                        {% else %}
                            Pin Table
                        {% endif %}
                    </a>
                  </div>
            
                </div>
              </div>
            </div>
            
            
            </div>
                    
        
        
            
        
            
        
        
            
        
        
          </div>
          {% endif %}        
        {% endfor %}
      </div>
    </div>
          {% include "includes/footer.html" %}


{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block scripts %}
  <!-- <script>
  $(document).ready(function() {
    // Initialize DataTable with export buttons
    var table = $('#PerformanceData').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copyHtml5',
            'excelHtml5',
            'csvHtml5',
            'pdfHtml5'
        ]
    });
  
    // Initialize Date Range Picker
    $('#dateRange').daterangepicker({
        opens: 'left',
        autoUpdateInput: false,
        locale: {
            cancelLabel: 'Clear'
        }
    });
  
    // Apply the date range filter
    $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var min = picker.startDate;
                var max = picker.endDate;
                var date = moment(data[4], 'MMMM D, YYYY, h:mm a'); // Assuming your date is in the 5th column (index 4)
  
                if (min == null && max == null) {
                    return true;
                }
                if (min == null && date <= max) {
                    return true;
                }
                if (max == null && date >= min) {
                    return true;
                }
                if (date <= max && date >= min) {
                    return true;
                }
                return false;
            }
        );
        table.draw();
    });
  
    $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        $.fn.dataTable.ext.search.pop();
        table.draw();
    });
  });
  </script>
  <script src="{% static 'js/plugins/chartjs.min.js' %}"></script>
  <script>
    var ctx = document.getElementById("chart-bars").getContext("2d");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
          label: "Sales",
          tension: 0.4,
          borderWidth: 0,
          borderRadius: 4,
          borderSkipped: false,
          backgroundColor: "#fff",
          data: [450, 200, 100, 220, 500, 100, 400, 230, 500],
          maxBarThickness: 6
        }, ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
            },
            ticks: {
              suggestedMin: 0,
              suggestedMax: 500,
              beginAtZero: true,
              padding: 15,
              font: {
                size: 14,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
              color: "#fff"
            },
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false
            },
            ticks: {
              display: false
            },
          },
        },
      },
    });


    var ctx2 = document.getElementById("chart-line").getContext("2d");

    var gradientStroke1 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke1.addColorStop(1, 'rgba(203,12,159,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)'); //purple colors

    var gradientStroke2 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)'); //purple colors

    new Chart(ctx2, {
      type: "line",
      data: {
        labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
            label: "Mobile apps",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#cb0c9f",
            borderWidth: 3,
            backgroundColor: gradientStroke1,
            fill: true,
            data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
            maxBarThickness: 6

          },
          {
            label: "Websites",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#575f9a",
            borderWidth: 3,
            backgroundColor: gradientStroke2,
            fill: true,
            data: [30, 90, 40, 140, 290, 290, 340, 230, 400],
            maxBarThickness: 6
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              padding: 10,
              color: '#b2b9bf',
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#b2b9bf',
              padding: 20,
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
        },
      },
    });
  </script> -->

{% endblock scripts %}
