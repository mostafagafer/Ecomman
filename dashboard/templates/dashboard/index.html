{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}

    <div class="container-fluid py-4">

      <div class="raw mt-3">
        <H1>Welcome {{ request.user.username }} </H1>
      </div> 
      <div class="row mt-5">
        <div class="col-xl-3 col-sm-6 mb-l-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Price</p>
                    <h5 class="font-weight-bolder mb-0">
                      {{ summary_data.latest_opps|floatformat:"2" }}
                        {% if summary_data.opps_difference == 0 %}
                        <span class="text-secondary text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                        {% elif summary_data.opps_difference > 0 %}
                        <span class="text-success text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                        {% else %}
                        <span class="text-danger text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                      {% endif %}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Availability</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-success text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Assortment</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-danger text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">PPD</p>
                    <h5 class="font-weight-bolder mb-0">
                      **
                      <span class="text-success text-sm font-weight-bolder">--%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      
  <div class="row mt-4">
    <div class="col-lg-7 mb-lg-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-lg-6">
              <div class="d-flex flex-column h-100">
                <h5 class="font-weight-bolder">EcomMan Score</h5>
                <p class="mb-5">With EcomMan Score. Our powerful AI tool, you can manage and forcast
                  moniter the overall pefrormance of your products with just one number. 
                </p>
                <a class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
                  Read More
                  <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
                </a>
              </div>
            </div>
            <div class="col-lg-5 ms-auto text-center mt-5 mt-lg-0">
              <div class="bg-gradient border-radius-lg h-100">
                <div class="position-relative d-flex align-items-center justify-content-center h-100 border border-4 border-danger">
                  <div class=" card numbers">
                    <h1>{{ summary_data.latest_opps|floatformat:"2" }}</h1>  

                    {% if summary_data.opps_difference == 0 %}
                    <span class="text-secondary text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                    {% elif summary_data.opps_difference > 0 %}
                    <span class="text-success text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                    {% else %}
                    <span class="text-danger text-sm font-weight-bolder">{{ summary_data.opps_difference|floatformat:"2"  }}</span>
                  {% endif %}

                      <!-- <h1>69.24 </h1>  
                      <span class="text-danger text-sm font-weight-bolder">-13.56</span> -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card h-100 p-3">
        <div class="overflow-hidden position-relative border-radius-lg bg-cover h-100" style="background-image: url('{% static 'img/ivancik.jpg' %}')">
          <span class="mask bg-gradient-dark"></span>
          <div class="card-body position-relative z-index-1 d-flex flex-column h-100 p-3">
            <h5 class="text-white font-weight-bolder mb-4 pt-2">EcomMan Report</h5>
            <p class="text-white">Check out your tailered report gerenrated by AI with full SWOT analysis for each one of your products. with the power
               of machine learning, now you can make sure that your products will rull
              
            </p>
            <a class="text-white text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
              Read More
              <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

<br>

      <div class="row my-4">
        <head>
          <meta charset="UTF-8">
          <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
          <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
      
          <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
          <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
          <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
          <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
      </head>


      <div class="raw mt-3">
        <h2>My Favourite Views</h2>
      </div> 
      <p>

        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
          My Favourite Views
        </button>
      </p>
      <div class="collapse" id="collapseExample">
        {% for pinned_table in pinned_tables %}

          {% if pinned_table.table_name == 'PerformanceData' %}
            <h3>{{ pinned_table.table_name }}</h3>
            <table id="PerformanceData" class="display">

              <thead>
              <tr>
                <th>Product Title</th>
                <th>Promo Flag</th>
                <th>Final Price</th>
                {% for column in columns %}
                  {% if "_price" in column.name %}
                    <th>{{ column.header }}</th>
                  {% endif %}
                {% endfor %}
          
                {% if show_amazon_sold_by %}
                <th>Amazon Sold By</th>
                {% endif %}
          
                <th>Amazon Ratio</th>
                <th>Dawa Ratio</th>
                <th>Nahdi Ratio</th>
          
                <th>PCS</th>
                <th>PDS</th>
                <th>OPPS</th>
                <th>Update at</th>
          
              </tr>
            </thead>
            <tbody>
              {% for row in scraped_data %}
                <tr>
                  <td>{{ row.product.TITLE }}</td>
          
                  <td class="align-middle text-center text-sm">
                    {% if row.promo_flag %}
                    <span class="badge badge-sm bg-gradient-success">ON</span>        
                    {% else %}
                    <span class="badge badge-sm bg-gradient-secondary">OFF</span>        
                    {% endif %}
                  </td>
          
          
                  <td>{{ row.final_price|floatformat:2 }}</td>
                  {% for column in columns %}
                    {% if "_price" in column.name %}
                      <td>
                        {# Get the corresponding compliance flag dynamically using the custom replace filter #}
                        {% with compliance_flag=column.name|replace:"price,compliance_flag" %}
                          {% if row|get_item2:compliance_flag %}
                            <span class="badge bg-success">{{ row|get_item2:column.name|default_if_none:"N/A" }}</span>
                          {% else %}
                            <span class="badge bg-danger">{{ row|get_item2:column.name|default_if_none:"N/A" }}</span>
                          {% endif %}
                        {% endwith %}
                      </td>
                    {% endif %}
                  {% endfor %}
          
          
          
                  {% if show_amazon_sold_by %}
                  <td class="text-center">
                      {% if row.amazon_sold_by != "Amazon.sa" %}
                          <span style="color: red;">{{ row.amazon_sold_by }}</span>
                      {% else %}
                          {{ row.amazon_sold_by }}
                      {% endif %}
                  </td>
                  {% endif %}
          
                  <td>{{ row.amazon_ratio|floatformat:2|default:"N/A" }}</td>
                  <td>{{ row.dawa_ratio|floatformat:2|default:"N/A" }}</td>
                  <td>{{ row.nahdi_ratio|floatformat:2|default:"N/A" }}</td>
          
              
                  <td>{{ row.pcs|floatformat:2 }}%</td>
                  <td>{{ row.price_deviation_score|floatformat:2 }}%</td>
                  <td>{{ row.opps|floatformat:2 }}%</td>        
                  <td>{{ row.scraped_at|date:"F j, Y, g:i a"  }}</td>
          
                </tr>
              {% endfor %}
            </tbody>
            </table>
          {% endif %}

          {% if pinned_table.table_name == 'CurrentPriceStatus' %}

          <div class="row">
            <div class="row mt-4">
              <h1>Current Price Status </h1>
            </div>
        
            <div class="col-12">
              <div class="card">
                <div class="card-header pb-0">
                  <div class="row">
                    <div class="col-lg-6 col-7">
                      <p class="text-sm mb-0">
                        The table's last update was on <span style="font-weight: bold;" >{{ latest_scraped_date|date:"F j, Y, g:i a" }}</span>
                    </div>
                  </div>
        
                  <div class="row mt-4">
                    <div class="container-fluid">
                      <form action="{% url 'dashboard:trigger_scrape_for_user_products' %}" method="post">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                          <button class="btn btn-primary" type="submit">Update Price Now</button>
                        </div>
                      </form>
                    </div>
        
                  </div>
                <div class="card-body px-0 pb-2">
                  <div class="table-responsive">
                    
                    <table class="table align-items-center mb-0" id="CurrentPriceStatus" class="display">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Product</th>
                          <th class="text-center text-secondary text-xxs font-weight-bolder opacity-7 ps-2">RSV|RSV+VAT</th>
                          <th class="text-center text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Reference Price</th>
                          <th class="text-center text-secondary text-xxs font-weight-bolder opacity-7 ps-2">On Promo</th>
                          
                          {% for column in columns %}
                          {% if "_price" in column.name %}
                            <th class="text-center text-secondary text-xxs font-weight-bolder opacity-7 ps-2">{{ column.header }}</th>
                          {% endif %}
                        {% endfor %}
                                
                        <!-- <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">PDS</th> -->
                      </tr>
                      </thead>
                        <tbody>
                          {% for data in max_scraped_data  %}
                          <tr>
                              <td>
                                  <div class="d-flex px-2 py-1">
        
                                  <div class="d-flex flex-column justify-content-center">
                                  <h6 class="mb-0 text-sm">{{data.product.TITLE}}</h6>
                              </div>
                              </div>
                              </td>
                              <td class="align-middle text-center text-sm">
                                <span class="text-xs font-weight-bold"> {{data.product.RSP|floatformat:"2"}}</span>
                                <br>
                                <span class="text-xs">{{ data.product.RSP_VAT|floatformat:"2" }}</span>
                              </td>
        
                              <td class="align-middle text-center text-sm">
                                <span class="text-xs font-weight-bold"> {{ data.final_price |floatformat:"2" }}</span>
                              </td>
        
        
                              <td class="align-middle text-center text-sm">
        
                                {% if data.promo_flag %}
                                <span class="badge badge-sm bg-gradient-success">{{data.discount_percentage}}%</span>        
        
                                {% else %}
                                <span class="badge badge-sm bg-gradient-secondary">OFF</span>        
        
                                {% endif %}
                              </td>
        
                              {% for column in columns %}
                              {% if "_price" in column.name %}
                                <td class="align-middle text-center text-sm">
                                  <div class="d-flex align-items-center justify-content-center">
                                    {% with compliance_flag=column.name|replace:"price,compliance_flag" %}
                                      {% if data|get_item2:compliance_flag %}
                                        <span>{{ data|get_item2:column.name|default_if_none:"N/A" }}</span>
                                      {% else %}
                                        <span class="badge bg-danger">{{ data|get_item2:column.name|default_if_none:"N/A" }}</span>
                                      {% endif %}
                                      
                                      {% if column.name == "amazon_price" and data.amazon_sold_by != "Amazon.sa" %}
                                        <svg 
                                          xmlns="http://www.w3.org/2000/svg" 
                                          width="16" 
                                          height="16" 
                                          fill="red" 
                                          class="bi bi-shop ms-2" 
                                          viewBox="0 0 16 16"
                                          data-bs-toggle="popover" 
                                          data-bs-placement="right" 
                                          data-bs-content="Sold by: {{ data.amazon_sold_by }}"
                                          style="cursor: pointer;">
                                          <path d="M2.97 1.35A1 1 0 0 1 3.73 1h8.54a1 1 0 0 1 .76.35l2.609 3.044A1.5 1.5 0 0 1 16 5.37v.255a2.375 2.375 0 0 1-4.25 1.458A2.37 2.37 0 0 1 9.875 8 2.37 2.37 0 0 1 8 7.083 2.37 2.37 0 0 1 6.125 8a2.37 2.37 0 0 1-1.875-.917A2.375 2.375 0 0 1 0 5.625V5.37a1.5 1.5 0 0 1 .361-.976zm1.78 4.275a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 1 0 2.75 0V5.37a.5.5 0 0 0-.12-.325L12.27 2H3.73L1.12 5.045A.5.5 0 0 0 1 5.37v.255a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0M1.5 8.5A.5.5 0 0 1 2 9v6h1v-5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5h6V9a.5.5 0 0 1 1 0v6h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1V9a.5.5 0 0 1 .5-.5M4 15h3v-5H4zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1zm3 0h-2v3h2z"/>
                                        </svg>
        
                                      {% endif %}
                                      
                                    {% endwith %}
                                  </div>
                                </td>
                              {% endif %}
                            {% endfor %}
                                                                                                    
                              <!-- <td class="align-middle text-center text-sm">
                                <div class="progress-wrapper w-75 mx-auto">
                                  <div class="progress-info">
                                  <div class="progress-percentage">
                                  <span class="text-xs font-weight-bold">{{data.price_deviation_score|floatformat:"2"}}%</span>
                                  </div>
                                  </div>
                                  <div class="progress">
                                  <div class="progress-bar bg-gradient-info w-20" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                              </td> -->
                              
                          </tr>
                            {% endfor %}
        
                        </tbody>
                    </table>
        
        
                  </div>
                </div>
        
                <!-- Rounded switch -->
                <!-- <div class="col p-4">
                  <label class="switch">
                    <input type="checkbox">
                    <span class="slider round"></span>
                  </label>
                </div>   -->
                <div class="col p-4">
                  <a href="{% url 'dashboard:toggle_pin_table' 'CurrentPriceStatus' %}" >
                      {% if is_table_pinned %}
                          Unpin Table
                      {% else %}
                          Pin Table
                      {% endif %}
                  </a>
                </div>
              
              </div>
        
            </div>
          </div>
        
        
        
            
        
            
        
        
            
        
        
          </div>
          {% endif %}        
        {% endfor %}
      </div>
    </div>
          {% include "includes/footer.html" %}


{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block scripts %}
  <!-- <script>
  $(document).ready(function() {
    // Initialize DataTable with export buttons
    var table = $('#PerformanceData').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copyHtml5',
            'excelHtml5',
            'csvHtml5',
            'pdfHtml5'
        ]
    });
  
    // Initialize Date Range Picker
    $('#dateRange').daterangepicker({
        opens: 'left',
        autoUpdateInput: false,
        locale: {
            cancelLabel: 'Clear'
        }
    });
  
    // Apply the date range filter
    $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var min = picker.startDate;
                var max = picker.endDate;
                var date = moment(data[4], 'MMMM D, YYYY, h:mm a'); // Assuming your date is in the 5th column (index 4)
  
                if (min == null && max == null) {
                    return true;
                }
                if (min == null && date <= max) {
                    return true;
                }
                if (max == null && date >= min) {
                    return true;
                }
                if (date <= max && date >= min) {
                    return true;
                }
                return false;
            }
        );
        table.draw();
    });
  
    $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        $.fn.dataTable.ext.search.pop();
        table.draw();
    });
  });
  </script>
  <script src="{% static 'js/plugins/chartjs.min.js' %}"></script>
  <script>
    var ctx = document.getElementById("chart-bars").getContext("2d");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
          label: "Sales",
          tension: 0.4,
          borderWidth: 0,
          borderRadius: 4,
          borderSkipped: false,
          backgroundColor: "#fff",
          data: [450, 200, 100, 220, 500, 100, 400, 230, 500],
          maxBarThickness: 6
        }, ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
            },
            ticks: {
              suggestedMin: 0,
              suggestedMax: 500,
              beginAtZero: true,
              padding: 15,
              font: {
                size: 14,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
              color: "#fff"
            },
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false
            },
            ticks: {
              display: false
            },
          },
        },
      },
    });


    var ctx2 = document.getElementById("chart-line").getContext("2d");

    var gradientStroke1 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke1.addColorStop(1, 'rgba(203,12,159,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)'); //purple colors

    var gradientStroke2 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)'); //purple colors

    new Chart(ctx2, {
      type: "line",
      data: {
        labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
            label: "Mobile apps",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#cb0c9f",
            borderWidth: 3,
            backgroundColor: gradientStroke1,
            fill: true,
            data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
            maxBarThickness: 6

          },
          {
            label: "Websites",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#575f9a",
            borderWidth: 3,
            backgroundColor: gradientStroke2,
            fill: true,
            data: [30, 90, 40, 140, 290, 290, 340, 230, 400],
            maxBarThickness: 6
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              padding: 10,
              color: '#b2b9bf',
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#b2b9bf',
              padding: 20,
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
        },
      },
    });
  </script> -->

{% endblock scripts %}
